# DevMultiplier Academy - Website Development Environment
# Integrates with existing database infrastructure

# docker-compose up -d
# docker-compose down
# docker-compose down -v # Also remove volumes (data)

# Stop all containers
# docker stop dev-web dev-x-academy-web pgadmin postgres

# Remove/delete all containers:
# docker rm dev-web dev-x-academy-web pgadmin postgres

# docker exec -it postgres psql -U $Env:POSTGRES_USER -d $Env:POSTGRES_DB -c "SELECT version();"
# docker exec -it postgres bash

name: dev-web

services:
  dev-x-academy-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dev-x-academy-web
    hostname: dev-x-academy-web
    # Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
    # user: root
    command: sleep infinity # Overrides default command so things don't shut down after the process ends.
    environment:
      ACCEPT_EULA: ${ACCEPT_EULA:-'Y'}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-academy2026}
      POSTGRES_NON_ROOT_USER: ${POSTGRES_NON_ROOT_USER:-test}
      POSTGRES_NON_ROOT_PASSWORD: ${POSTGRES_NON_ROOT_PASSWORD:-test}
      POSTGRES_DB: ${POSTGRES_DB:-academy}
      POSTGRES_PORT: ${POSTGRES_PORT:-5433}
    volumes:
      - ../..:/workspaces:cached
    networks:
      - dev-web-net
    # Runs app on the same network as the database container, allows "forwardPorts" in devcontainer.json function.
    # network_mode: service:db
    # Use "forwardPorts" in **devcontainer.json** to forward an app port locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)

  postgres:
    # https://hub.docker.com/r/postgis/postgis
    image: postgis/postgis:18-3.6-alpine # PostgreSQL 18 with PostGIS 3.6 + all contrib extensions - PostgreSQL 18.1 (Debian 18.1-1.pgdg13+2) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit
    #image: postgis/postgis:18-3.6  # PostgreSQL 18 with PostGIS 3.6 + all contrib extensions - PostgreSQL 18.1 (Debian 18.1-1.pgdg13+2) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit
    #image: postgis/postgis:latest  # PostgreSQL 17.5 (Debian 17.5-1.pgdg110+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 10.2.1-6) 10.2.1 20210110, 64-bit
    #image: postgres:latest
    container_name: postgres
    hostname: postgres
    ports: ['${POSTGRES_PORT:-5433}:5433']
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-academy2026}
      POSTGRES_NON_ROOT_USER: ${POSTGRES_NON_ROOT_USER:-academy_user}
      POSTGRES_NON_ROOT_PASSWORD: ${POSTGRES_NON_ROOT_PASSWORD:-academy_password}
      POSTGRES_DB: ${POSTGRES_DB:-academy}
      POSTGRES_PORT: ${POSTGRES_PORT:-5433}
      POSTGRES_INITDB_ARGS: ${POSTGRES_INITDB_ARGS:-"--encoding=UTF8 --locale=en_US.UTF-8"}
      PGDATA: ${PGDATA:-/var/lib/postgresql/18/docker} # PostgreSQL 18+ uses version-specific PGDATA
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-scram-sha-256}
    volumes:
      - postgres_web_data:/var/lib/postgresql
      - postgres_web_backups:/var/lib/postgresql/backups
      - ./config/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/postgres/init-user-db.sh:/docker-entrypoint-initdb.d/01-init-user-db.sh:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-8s}
      retries: ${HEALTHCHECK_RETRIES:-10}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - dev-web-net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # user: postgres  # Commented out to allow proper volume permissions
    shm_size: ${POSTGRES_SHM_SIZE:-2.81G} # Increased for better performance with parallel queries
    deploy:
      resources:
        limits:
          cpus: ${POSTGRES_CPU_LIMITS:-4}
          memory: ${POSTGRES_MEMORY_LIMITS:-18G}
        reservations:
          cpus: ${POSTGRES_CPU_RESERVATIONS:-2}
          memory: ${POSTGRES_MEMORY_RESERVATIONS:-11G}

  pgadmin:
    image: dpage/pgadmin4:9.11
    container_name: pgadmin
    hostname: pgadmin
    ports: ['${PGADMIN_PORT:-8008}:80']
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-YourVeryStr0ngPassword}
    volumes: [pgadmin_web_data:/var/lib/pgadmin]
    depends_on: [postgres]
    networks:
      - dev-web-net
    restart: unless-stopped

volumes:
  node_modules:
    #driver: local
  bun_cache:
    #driver: local
  postgres_web_data:
    #driver: local
  postgres_web_backups:
    #driver: local
  pgadmin_web_data:
    #driver: local

networks:
  dev-web-net:
    driver: bridge
